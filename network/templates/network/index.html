{% extends "network/layout.html" %}

{% load static %}

{% block body %}
    <form action="{% url 'new_post' %}" id='form-post' class="mt-3" method="POST">
        {% csrf_token %}
        <div class="form-group">
            <label for="new_post" class="text-dark">New Post</label>
            <input class="form-control" type="text" name="new_post" id="new_post" maxlength="140">
        </div>
        <input class="btn btn-secondary" type="submit" value="Post">
    </form>
    <h3 class="m-3">All Posts</h3>
    {% for post in posts %}
    <div class="post-wrapper">
        <h5 >{{post.user}}</h5>
        {% if request.user == post.user %}
            <a href="#" class="edit" data-post ='{{post.id}}'>Edit</a>
        {% endif %}
        <div>{{post.post_text}}</div>
        <div>{{post.date}}</div>
        <div>
            {{post.count}}
        </div>
        <div>Comment</div>
    </div>
    {% endfor %}
{% endblock %}

{% block scripts %}
<script src="{% static 'network/getCookie.js' %}"></script>

<script>
    // script for processing editing of posts
    addEventListener('DOMContentLoaded', listeners);

    function listeners(){
        edit = document.querySelector('.edit');
        if (edit){
            edit.addEventListener('click', processEdit);
        }
    }

    function processEdit(event){
        event.preventDefault();
        // 'this' is the anchor 'edit' element
        let post_id = this.dataset.post;
        // post is the 'div' next to it
        let post = this.nextElementSibling;
        let post_text = post.innerHTML;
        post.innerHTML = '';
        post.innerHTML = `<textarea rows="2" cols="100">${post_text}</textarea>`;
        let textarea = document.querySelector('textarea');
        textarea.addEventListener('change', function(event){
            post.innerHTML = textarea.value;
            // update database
            let csrftoken = getCookie('csrftoken');
            fetch(`/update/${post_id}`, {
                method:'PUT',
                headers: {
                "X-CSRFToken": csrftoken,
                "Accept": "application/json",
                "Content-Type": "application/json"
                },
                credentials: 'same-origin',
                body: JSON.stringify({newText:post.innerHTML})
            })
            .then(response => {
                console.log(response.status);
                return response.text();
            })
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.log(error);
            });
        });
    }
</script>
{% endblock %}