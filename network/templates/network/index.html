{% extends "network/layout.html" %}

{% load static %}

{% block body %}
    <form action="{% url 'new_post' %}" id='form-post' class="mt-3" method="POST">
        {% csrf_token %}
        <div class="form-group">
            <label for="new_post" class="text-dark">New Post</label>
            <input class="form-control" type="text" name="new_post" id="new_post" maxlength="140">
        </div>
        <input class="btn btn-secondary" type="submit" value="Post">
    </form>
    <h3 class="m-3">All Posts</h3>
    {% for post in posts %}
    <div class="post-wrapper">
        <h5 >{{post.user}}</h5>
        {% if request.user == post.user %}
            <a href="#" class="edit edit-btn" data-post ='{{post.id}}'>Edit</a>
        {% endif %}
        <div>{{post.post_text}}</div>
        <div>{{post.date}}</div>
        <div>
            {% if request.user in post.liked_by_all %}
                <button class="like-btn" id="{{post.id}}">Unlike</button>
            {% else %}
                <button class="like-btn" id="{{post.id}}">Like</button>
            {% endif %}
                <span class="counter" data-counter="{{post_id}}">{{post.likes_count}}</span>
        </div>
        <div>Comment</div>
    </div>
    {% endfor %}
{% endblock %}

{% block scripts %}
<script src="{% static 'network/getCookie.js' %}"></script>

<script>
    addEventListener('DOMContentLoaded', listeners);

    function listeners(){

        // processing likes and unlikes
        like_buttons = document.querySelectorAll('.like-btn')
        like_buttons.forEach(button => {
            button.addEventListener('click', processLike)
        });

         // script for processing editing of posts
        edit_links = document.querySelectorAll('.edit');
        edit_links.forEach(link => {
            link.addEventListener('click', processEdit);
        });       
    }

    function processLike(){
        let button = this;
        let button_text = this.innerHTML;
        let post_id = this.id
        console.log(post_id, button_text);

        // update database
        let csrftoken = getCookie('csrftoken');
        fetch(`/update/${post_id}/likes`, {
            method:'PUT',
            headers: {
            "X-CSRFToken": csrftoken,
            "Accept": "application/json",
            "Content-Type": "application/json"
            },
            credentials: 'same-origin',
            body: JSON.stringify({action:button_text})
        })
        .then(response => {
            // console.log(response.status);
            return response.json();
        })
        .then(data => {
            console.log(data);
            if ('likes_count' in data){
                    // update number of likes
                    let count = data['likes_count'];
                    let counter_elem =  button.nextElementSibling;
                    counter_elem.innerHTML = count;
                    // update button text
                    button.innerHTML = data['next_action'];
                }
        })
        .catch(error => {
            console.log(error);
        });
    }

    function processEdit(event){
        event.preventDefault();
        // 'this' is the anchor 'edit' element
        let post_id = this.dataset.post;
        // post is the 'div' next to it
        let post = this.nextElementSibling;
        let post_text = post.innerHTML;
        post.innerHTML = '';
        post.innerHTML = `<textarea rows="2" cols="100">${post_text}</textarea>`;
        let textarea = document.querySelector('textarea');
        textarea.addEventListener('change', function(event){
            post.innerHTML = textarea.value;
            // update database
            let csrftoken = getCookie('csrftoken');
            fetch(`/update/${post_id}/edit`, {
                method:'PUT',
                headers: {
                "X-CSRFToken": csrftoken,
                "Accept": "application/json",
                "Content-Type": "application/json"
                },
                credentials: 'same-origin',
                body: JSON.stringify({newText:post.innerHTML})
            })
            .then(response => {
                // console.log(response.status);
                return response.text();
            })
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.log(error);
            });
        });
    }
</script>
{% endblock %}